<?php

// 1) Obter dados da API
$url  = "https://api.truckersmp.com/v2/events";
$json = @file_get_contents($url);
$data = json_decode($json, true);

// 2) Verificar se existe 'response' e se é array
if ($data && isset($data['response']) && is_array($data['response'])) {

    // Extrair cada array (se existirem), ou usar arrays vazios
    $featured = $data['response']['featured'] ?? [];
    $upcoming = $data['response']['upcoming'] ?? [];
    $recent   = $data['response']['recent']   ?? [];

    // 3) Combinar todos os eventos em um só array
    $allEvents = array_merge($featured, $upcoming, $recent);

    // Se não houver eventos
    if (count($allEvents) === 0) {
        echo "<p>Não há nenhum evento (featured, upcoming ou recent) no momento.</p>";
        return;
    }

    // Configuração da paginação
    $items_per_page = 5; // Número de eventos por página
    $current_page = isset($_GET['page']) ? (int)$_GET['page'] : 1;
    if ($current_page < 1) {
        $current_page = 1;
    }

    // Cálculo do total de páginas
    $total_items = count($allEvents);
    $total_pages = (int)ceil($total_items / $items_per_page);

    // Garantir que a página atual não exceda o número total de páginas
    if ($current_page > $total_pages) {
        $current_page = $total_pages;
    }

    // Determinar os índices para os itens a serem exibidos
    $start_index = ($current_page - 1) * $items_per_page;
    $end_index = min($start_index + $items_per_page, $total_items);

    // Subconjunto de eventos para a página atual
    $events_on_page = array_slice($allEvents, $start_index, $items_per_page);

    // Início do HTML
    echo '
        <style>
            /* Container de 5 colunas */
            .five-columns-container {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                justify-content: center;
                margin: 40px auto;
                max-width: 1400px;
            }

            .five-columns-item {
                flex: 0 0 calc(20% - 20px);
                box-sizing: border-box;
                position: relative;
                min-height: 300px;
                color: #fff;
                border-radius: 6px;
                overflow: hidden;
            }

            .five-columns-item > div {
                background: rgba(0, 0, 0, 0.5);
                padding: 20px;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
            }

            .button-ujarak {
                display: inline-block;
                padding: 10px 20px;
                background: #576eff;
                color: #fff;
                text-decoration: none;
                border-radius: 4px;
                text-align: center;
                transition: background 0.3s;
            }

            .button-ujarak:hover {
                background: #4655cc;
            }

            /* Paginação */
            .pagination {
                display: flex;
                justify-content: center;
                list-style: none;
                margin: 20px 0;
                padding: 0;
            }

            .pagination li {
                margin: 0 5px;
            }

            .pagination a {
                display: inline-block;
                padding: 10px 15px;
                background: #007bff;
                color: #fff;
                text-decoration: none;
                border-radius: 4px;
            }

            .pagination a:hover {
                background: #0056b3;
            }

            .pagination .active {
                background: #0056b3;
                cursor: default;
            }
        </style>
        <section class="section section-sm section-first bg-default text-center">
            <div class="container">
                <h3>Eventos e VTC - Detalhados</h3>
                <div class="five-columns-container">
    ';

    // Exibir eventos da página atual
    foreach ($events_on_page as $event) {
        $eventName = htmlspecialchars($event["name"] ?? "Sem nome");
        $banner    = htmlspecialchars($event["banner"] ?? "/public/images/Banner/Eventos/ets-ats.jpg");
        $eventId   = htmlspecialchars($event["id"]); // ID do evento para obter detalhes
        $eventUrl  = "Detail?id={$eventId}"; // Gerar link com o ID do evento

        echo "
            <div class='five-columns-item' style='
                background-image: url(\"{$banner}\");
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;'>
                <div>
                    <h3 class='box-icon-modern-big-title' style='margin: 0;'>{$eventName}</h3>
                    <div class='box-icon-modern-decor' style='margin: 10px auto;'></div>
                    <a class='button-ujarak' href='{$eventUrl}' target='_self'>Ver Detalhes</a>
                </div>
            </div>
        ";
    }

    echo '
                </div>
            </div>
        </section>
        <ul class="pagination">
    ';

    // Paginação
    for ($i = 1; $i <= $total_pages; $i++) {
        if ($i == $current_page) {
            echo "<li><a href='#' class='active'>{$i}</a></li>";
        } else {
            echo "<li><a href='?page={$i}'>{$i}</a></li>";
        }
    }

    echo '
        </ul>

    ';

} else {
    // Caso a API não tenha dados ou tenha ocorrido um erro
    echo "<p>Não foi possível obter os eventos ou não há eventos disponíveis no momento.</p>";
}
?>